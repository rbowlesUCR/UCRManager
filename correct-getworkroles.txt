/**
 * Get available work roles from ConnectWise
 */
export async function getWorkRoles(
  tenantId: string
): Promise<Array<{ id: number; name: string }>> {
  try {
    const credentials = await getConnectWiseCredentials(tenantId);
    if (!credentials) {
      throw new Error('ConnectWise credentials not configured for this tenant');
    }

    const apiUrl = new URL(`${credentials.baseUrl}/v4_6_release/apis/3.0/time/workRoles`);
    console.log(`[ConnectWise] Fetching work roles from ${apiUrl.toString()}`);

    const response = await fetch(apiUrl.toString(), {
      method: 'GET',
      headers: createHeaders(credentials),
      signal: AbortSignal.timeout(10000),
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`ConnectWise API error: ${response.status} - ${errorText}`);
    }

    const workRoles = await response.json();
    console.log(`[ConnectWise] Found ${workRoles.length} work roles`);

    return workRoles.map((role: any) => ({
      id: role.id,
      name: role.name,
    }));
  } catch (error: any) {
    console.error('[ConnectWise] Error fetching work roles:', error);
    throw new Error(`Failed to fetch work roles: ${error.message}`);
  }
}
